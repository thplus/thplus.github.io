---
title: OnTheTop Service
date: 2025-07-07
categories: [Project, KTB]
tags: [python, fastapi, cnn, computer_vision]
math: true
---
# 프로젝트 소개
**OnTheTop**<br/>

- 데스크 테리어에 관심있는 사람들을 위해 생성형 AI 기반으로 퍼스널 데스크 특가 정보를 제공
  - 사용자의 데스크 셋업 이미지를 분석해 어울리는 아이템 이미지를 생성하고 클릭하면 바로 구매할 수 있는 쇼핑 링크를 제공
  
## 주요기능
- 사용자가 업로드한 책상 이미지를 AI가 분석하여 데스크 환경을 인식하고 어울리는 데스크 아이템을 추천
- 추천된 아이템을 Diffusion 모델을 기반으로 추천 데스크 셋업 이미지 생성
- 생성된 이미지를 기반으로 추천된 아이템을 구매할 수 있는 쇼핑 링크 제공
- 다양한 Style LoRA를 적용하여 MSPainting Style, Oil Painting Style, Cartoon Style 등 이미지 스타일 변경 기능 제공

# AI Server Architecture
![alt text](/assets/images/OTT_AI_Architect_v1.drawio.png)

## Folder
```
OTT_AI_Server
├── app
│   ├── core
│   │   ├── config.py
│   │   └── logging_config.py
│   ├── main.py
│   ├── routers
│   │   ├── __init__.py
│   │   ├── healthcheck.py
│   │   └── info.py
│   ├── services
│   │   ├── __init__.py
│   │   ├── backend_notify.py
│   │   ├── desk_classify.py
│   │   ├── gpt_api.py
│   │   ├── groundig_dino.py
│   │   ├── masking.py
│   │   ├── naverapi.py
│   │   ├── sam.py
│   │   └── sdxl_inpainting.py
│   ├── shutdown.py
│   ├── startup.py
│   └── utils
│       ├── clear_cache.py
│       ├── delete_image.py
│       ├── load_image.py
│       ├── mapping.py
│       ├── queue_manager.py
│       ├── s3.py
│       └── upscaling.py
├── README.md
├── requirements.txt
└── scripts
    ├── ai-server.service
    ├── start-ai.sh
    └── stop-ai.sh
```

# Trouble Shooting
## test version
### 1. 문제 개요
- **발생 배경**: 해당 서비스는 글쓰기, 댓글 달기 등 커뮤니티 기능을 제공하며 커뮤니티 기능이 있는 경우 사용자의 호기심을 유발하게 된다. 즉, 호기심 때문에 데스크 셋업과 관련되지 않은 사진을 업로드할 경우 예상하지 못한 이미지가 생성될 가능성이 있음
  - 따라서 BLIP2의 captioning 기술을 사용하여 "desk setup", "laptop", "monitor" 등 특정 키워드가 포함되어 있지 않거나 "people", "man", "woman" 등 불필요한 키워드가 포함되어 있을 경우 False로 처리하여 이미지 생성을 막는 기능 도입

- **문제 상황**: BLIP2의 경우 이미지의 caption을 생성하는데 수 초(T4 기준)의 시간이 소요된다. 따라서 Backend 입장에서는 이미지 분류만으로 수 초를 기다려야 하는 상황이 발생하며 이는 사용자 경험이 저하되는 상황으로 발전된다.

### 2. 해결책
- **이진 분류**: 초기 이미지 생성을 막기 위한 단계는 `True`, `False` 이진 분류 문제이므로 CNN을 이용한 방법 도입.

- **사용 이유**: 사전에 [Feature Map 기반 CNN 모델 최적화](/project/ktb/cnn_project/) 연구를 통해 경량화를 한다면 충분히 CPU에서 처리가능, 이를 이용한다면 이미지 생성은 GPU에서 데스크 분류는 CPU에서 비동기 처리 가능

### 3. 장단점 분석
||BLIP2|CNN|
|--|--|--|
|장점|1. 사용자에게 업로드한 사진이 desk가 아닌 이유에 대해 설명 가능|1. 빠른 처리 약 250ms<br/> 2. 이미지 생성과 비동기 처리 가능<br/> 3. 빠르게 통신을 끝내고 사용자는 다른 작업 가능|
|단점|1. 느린 처리 수 초<br/> 2. 비동기 처리 불가능, 이미지를 처리하고 있다면 호기심으로 올린 이미지를 판별하기 위해선 수 분에서 수십 분이 걸릴 수 있음|업로드한 사진이 desk가 아닌 이유에 대한 설명 불가능|

- **총평**: 이미지 생성시에 queue에 쌓아놓고 이미지를 생성하기 때문에 이미지 판별을 위해 수 분에서 수십 분이 걸릴 수 있는 상황이 생길 수 있으며, 이렇게 될 경우 backend와 사용자는 계속 기다릴 수가 없다. 따라서 CNN이 손실에 비해 얻는 부분이 많으므로 CNN을 채택

## MVP(v1)
### 1. 문제 개요
- **발생 배경**: img2txt → txt2img 환경, Base Model인 Stable Diffusion XL의 경우 prompt는 77tokens으로 제한된다. 따라서 이미지에 대한 자세한 prompt를 입력할 수 없어 업로드한 이미지와 생성된 이미지 간의 괴리감 발생

### 2. 해결책